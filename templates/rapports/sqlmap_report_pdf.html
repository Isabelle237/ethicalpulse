<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Rapport SQLMap - Scan #{{ scan.id }}</title>
    <style>
        body { font-family: Arial, sans-serif; font-size: 13px; color: #222; }
        h1, h2, h3 { color: #0d47a1; }
        .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 12px; }
        .bg-success { background: #4caf50; color: #fff; }
        .bg-danger { background: #e53935; color: #fff; }
        .bg-warning { background: #ffb300; color: #222; }
        .section { margin-bottom: 18px; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 10px; }
        th, td { border: 1px solid #bbb; padding: 4px 8px; }
        th { background: #f5f5f5; }
        pre { background: #222; color: #eee; padding: 8px; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>Rapport SQLMap - Scan #{{ scan.id }} ({{ scan.project.name }})</h1>
    <p><strong>Date :</strong> {{ scan.start_time|date:"d/m/Y H:i" }}</p>
    <p><strong>URL cible :</strong> {{ result.target_url|default:scan.project.url }}</p>
    <p><strong>Commande utilisée :</strong> <code>{{ result.options_used }}</code></p>
    <div class="section">
        <h2>Statut du scan :</h2>
        {% if scan.status == "completed" %}
            <span class="badge bg-success">Succès</span>
        {% elif scan.status == "failed" or scan.status == "error" %}
            <span class="badge bg-danger">Échec</span>
        {% else %}
            <span class="badge bg-warning">{{ scan.status }}</span>
        {% endif %}
    </div>
    <div class="section">
        <h2>Vulnérabilité détectée :</h2>
        {% if result.is_vulnerable %}
            <span class="badge bg-danger">VULNÉRABLE</span>
            <ul>
                <li><strong>Type d'injection :</strong> {{ result.injection_type }}</li>
                <li><strong>DBMS :</strong> {{ result.dbms }}</li>
                <li><strong>Payloads :</strong>
                    <ul>
                    {% for payload in result.payloads.splitlines %}
                        <li><code>{{ payload }}</code></li>
                    {% empty %}
                        <li>Aucun</li>
                    {% endfor %}
                    </ul>
                </li>
            </ul>
        {% else %}
            <span class="badge bg-success">Aucune vulnérabilité détectée</span>
        {% endif %}
    </div>
    <div class="section">
        <h2>Bases de données trouvées :</h2>
        {% if result.dbs_found %}
            <ul>
            {% for db in result.dbs_found.splitlines %}
                <li>{{ db }}</li>
            {% endfor %}
            </ul>
        {% else %}
            <p><em>Aucune</em></p>
        {% endif %}
    </div>
    <div class="section">
        <h2>Tables trouvées :</h2>
        {% if result.tables_found %}
            {% for db, tables in result.tables_found.items %}
                <strong>{{ db }}</strong>
                <ul>
                    {% for table in tables %}
                        <li>{{ table }}</li>
                    {% endfor %}
                </ul>
            {% endfor %}
        {% else %}
            <p><em>Aucune</em></p>
        {% endif %}
    </div>
    <div class="section">
        <h2>Colonnes trouvées :</h2>
        {% if result.columns_found %}
            <ul>
            {% for table, columns in result.columns_found.items %}
                <li><strong>{{ table }}</strong> : {{ columns|join:", " }}</li>
            {% endfor %}
            </ul>
        {% else %}
            <p><em>Aucune</em></p>
        {% endif %}
    </div>
    <div class="section">
        <h2>Données extraites :</h2>
        {% if result.data_dumped %}
            {% for table, rows in result.data_dumped.items %}
                <h4>{{ table }}</h4>
                <table>
                    <thead>
                        <tr>
                            {% for col in rows.0.keys %}
                                <th>{{ col }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in rows %}
                            <tr>
                                {% for val in row.values %}
                                    <td>{{ val }}</td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% endfor %}
        {% else %}
            <p><em>Aucune donnée extraite</em></p>
        {% endif %}
    </div>
    <div class="section">
        <h2>Sortie brute SQLMap :</h2>
        <pre>{{ result.raw_output|default:"Aucune sortie" }}</pre>
    </div>
</body>
</html>